name: Release Conda

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository and fetch tags
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          
      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          python-version: '3.12'
          channels: conda-forge
          auto-update-conda: true
          activate-environment: false

      - name: Create Conda environment with ctapipe
        shell: bash
        run: |
          conda create -y -n dl1dh -c conda-forge python=3.12 ctapipe
          conda activate dl1dh
          python --version
          
      - name: Install conda-build and anaconda-client
        shell: bash
        run: |
          conda install -y conda-build anaconda-client

      - name: Conda Build and Upload Package
        shell: bash
        env:
          ANACONDA_API_TOKEN: ${{ secrets.ANACONDA_TOKEN }}
        run: |
          CONDA_RECIPE_DIR=".github/conda"
          ANACONDA_CHANNEL="ctlearn-project"

          FULL_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0+dev")
          VERSION="${FULL_TAG#v}"
          VERSION="${VERSION#V}"

          echo "Building package version: $VERSION"
          export PACKAGE_VERSION=$VERSION
          
          # Build the package
          conda run -n dl1dh conda build $CONDA_RECIPE_DIR
          
          # Get the package path
          PACKAGE_PATH=$(conda run -n dl1dh conda build $CONDA_RECIPE_DIR --output)
          
          if [[ "$VERSION" != "0.0.0+dev" ]]; then
              echo "Uploading $PACKAGE_PATH to $ANACONDA_CHANNEL channel..."
              conda run -n dl1dh anaconda upload \
                "$PACKAGE_PATH" \
                --force \
                --user $ANACONDA_CHANNEL
          else
              echo "Skipping upload: Version is $VERSION (development)."
          fi
